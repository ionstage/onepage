!function(e){function t(){a="index.html",i.connect(f.prop.textarea,m.prop.element),i.connect(f.prop.insertButton,v.prop.element),i.connect(f.prop.canvas,g.prop.element),i.connect(f.prop.canvasHandle,g.prop.handleElement),i.connect(f.prop.publishTitleText,x.prop.element),i.connect(f.prop.publishButton,y.prop.element),i.connect(f.prop.publishPage,_.prop.element),i.connect(m.prop.text,h.prop.value),i.connect(h.prop.isEmpty,v.prop.disabled),i.connect(m.prop.text,g.prop.input),i.connect(v.event.click,g.event.insert),i.connect(v.event.click,m.event.empty),i.connect(E.prop.initialCanvasData,g.prop.data),i.connect(E.prop.initialTitleText,x.prop.text),i.connect(g.prop.data,E.prop.canvasData),i.connect(x.prop.text,E.prop.titleText),i.connect(E.prop.value,C.prop.value),i.connect(C.prop.isEmpty,y.prop.disabled),i.connect(y.event.click,_.event.show)}function n(){a="viewer.html",i.connect(f.prop.canvas,g.prop.element),i.connect(E.prop.initialCanvasData,g.prop.data),i.connect(E.prop.initialTitleText,T.prop.value)}var a,i=require("circuit"),o=require("js-base64").Base64,r=e.document,l="https://apis.google.com/js/client.js?onload=handleClientLoad",s={debounce:function(e,t){if("function"==typeof e){var n,a,i=null;return function(){n=this,a=arguments,null!==i&&clearTimeout(i),i=setTimeout(function(){e.apply(n,a)},t)}}},isPlainText:function(e){return 0!==e.indexOf("http://")&&0!==e.indexOf("https://")&&0!==e.indexOf("file://")&&0!==e.indexOf("data:image")},loadScript:function(e){var t=r.getElementsByTagName("script")[0],n=r.createElement("script");n.src=e,t.parentNode.insertBefore(n,t)},indexOf:function(){var e=Array.prototype.indexOf;return function(t,n){if(e&&t.indexOf===e)return t.indexOf(n);for(var a=0,i=t.length;i>a;a+=1)if(t[a]===n)return a;return-1}}()},u={get:function(e){return r.getElementById(e)},setEvent:function(e,t,n){e.addEventListener(t,n,!1)},getValue:function(e){return e.value},setValue:function(e,t){e.value=t},hasClass:function(e,t){var n=e.className;return-1!==(n+" ").indexOf(t+" ")},addClass:function(e,t){var n=e.className;-1===(" "+n).indexOf(" "+t)&&(e.className=(n+" "+t).trim())},removeClass:function(e,t){"undefined"==typeof t&&(e.className=""),u.hasClass(e,t)&&(e.className=(e.className+" ").replace(t+" ","").trim())},makeCSSText:function(e){var t="";for(var n in e)t=t+n+":"+e[n]+";";return t},setDropEvent:function(e,t){e.addEventListener("dragover",function(e){e.preventDefault()},!1),e.addEventListener("drop",function(e){if(e.preventDefault(),"function"==typeof t){for(var n=e.target,a=0,i=0;n&&"canvas"!==n.id;)a+=n.offsetLeft,i+=n.offsetTop,n=n.offsetParent;var o=e.dataTransfer,r=o.types,l=o.getData("Text");if(r&&-1!==s.indexOf(r,"text/html")&&-1!==s.indexOf(r,"text/uri-list")){var u=o.getData("text/html"),p=u.match(/<img.*?src=(["\'])(.+?)\1.*?>/i);p&&(l=p[2])}var c=-1!==navigator.userAgent.toLowerCase().indexOf("firefox"),d=e.layerX+a-(c?0:5),f=e.layerY+i-(c?0:5);t({text:l,x:d,y:f})}},!1)},createImageElement:function(e){var t=new Image;return t.className="canvas-element canvas-element-image",t.src=e,t},appendImageElementWithCenterPosition:function(e,t,n,a,i){var o=u.createImageElement(t);o.style.visibility="hidden",o.onload=function(){var e=getComputedStyle(o,null),t=parseInt(e.width),r=parseInt(e.height);t>640&&(r*=640/t,t=640),r>480&&(t*=480/r,r=480),"undefined"==typeof n&&(n=320),"undefined"==typeof a&&(a=20+r/2),o.style.cssText=u.makeCSSText({left:n-t/2+"px",top:a-r/2+"px",width:t+"px",height:r+"px"}),"function"==typeof i&&i()},o.onerror=function(){u.remove(o),alert("Load error!")},e.appendChild(o)},createTextElement:function(e){var t=r.createElement("div");t.className="canvas-element canvas-element-text";for(var n=e.split("\n"),a=0,i=n.length;i>a;a+=1){var o=r.createElement("div"),l=n[a];""===l?o.innerHTML="&nbsp;":o.textContent=l,t.appendChild(o)}return t},appendTextElementWithCenterPosition:function(e,t,n,a,i,o){var r=u.createTextElement(t);r.style.visibility="hidden",e.appendChild(r);var l=getComputedStyle(r,null),s=parseInt(l.width),p=parseInt(l.height);"undefined"==typeof n&&(n=320),"undefined"==typeof a&&(a=20+p/2),r.style.cssText=u.makeCSSText({left:n-s/2+"px",top:a-p/2+"px","font-size":i+"px"}),"function"==typeof o&&o()},adjustTargetPosition:function(e,t,n,a){var e=Math.max(e,20-n),t=Math.max(t,20-a);return e>620&&(e=620),t>460&&(t=460),{left:e+"px",top:t+"px"}},setDragMoveEvent:function(){var t="ontouchstart"in e,n=t?"touchstart":"mousedown",a=t?"touchmove":"mousemove",i=t?"touchend":"mouseup";return function(e,o){function l(e,t){var n=u.adjustTargetPosition(f.left+e,f.top+t,m.width,m.height);u.setPosition(c,n)}function s(e){e.preventDefault(),e.stopPropagation(),e=t?e.touches[0]:e;var n=e.pageX-d.left,a=e.pageY-d.top;l(n,a),"function"==typeof o.drag&&o.drag({target:c})}function p(e){if(e.preventDefault(),e.stopPropagation(),!(t&&e.touches.length>0)){e=t?e.changedTouches[0]:e,r.removeEventListener(a,s,!1),r.removeEventListener(i,p,!1);var n=e.pageX-d.left,u=e.pageY-d.top;l(n,u),"function"==typeof o.end&&o.end({target:c})}}var c,d,f,m;e.addEventListener(n,function(e){if(c=e.target,o.handleClass)for(;c&&!u.hasClass(c,o.handleClass);)c=c.parentNode;if(null!==c){f={left:parseInt(c.style.left),top:parseInt(c.style.top)};var n=getComputedStyle(c,null);m={width:parseInt(n.width),height:parseInt(n.height)},e.preventDefault(),e.stopPropagation(),e=t?e.touches[0]:e,d={left:e.pageX,top:e.pageY},"function"==typeof o.start&&o.start({target:c}),r.addEventListener(a,s,!1),r.addEventListener(i,p,!1)}},!1)}}(),isChild:function(e,t){do if(e=e.parentNode,e===t)return!0;while(e&&e!==t);return!1},isTouchEnabled:"ontouchstart"in e,remove:function(e){e.parentNode.removeChild(e)},isFirstChild:function(e){return null===e.previousElementSibling},isLastChild:function(e){return null===e.nextElementSibling},up:function(e){var t=e.parentNode,n=e.nextElementSibling?e.nextElementSibling.nextElementSibling:null;t.insertBefore(e,n)},down:function(e){var t=e.parentNode,n=e.previousElementSibling;t.insertBefore(e,n)},getPosition:function(e){var t=getComputedStyle(e,null);return{left:t.left,top:t.top}},setPosition:function(e,t){e.style.left=t.left,e.style.top=t.top},getSize:function(e){var t=getComputedStyle(e,null);return{width:t.width,height:t.height}},setSize:function(e,t){e.style.width=t.width,e.style.height=t.height},blur:function(e){e.blur&&e.blur()},setDragEvent:function(){var t="ontouchstart"in e,n=t?"touchstart":"mousedown",a=t?"touchmove":"mousemove",i=t?"touchend":"mouseup";return function(e,o){function l(e){e.preventDefault(),e.stopPropagation(),e=t?e.touches[0]:e;var n=e.pageX-u.left,a=e.pageY-u.top;"function"==typeof o.drag&&o.drag(n,a)}function s(e){if(e.preventDefault(),e.stopPropagation(),!(t&&e.touches.length>0)){e=t?e.changedTouches[0]:e,r.removeEventListener(a,l,!1),r.removeEventListener(i,s,!1);var n=e.pageX-u.left,p=e.pageY-u.top;"function"==typeof o.end&&o.end(n,p)}}var u;e.addEventListener(n,function(e){e.preventDefault(),e.stopPropagation(),e=t?e.touches[0]:e,u={left:e.pageX,top:e.pageY},"function"==typeof o.start&&o.start(u.left,u.top),r.addEventListener(a,l,!1),r.addEventListener(i,s,!1)},!1)}}(),getFontSize:function(e){return e.style.fontSize},setFontSize:function(e,t){e.style.fontSize=t},children:function(e){return e.children},getTextContent:function(e){for(var t=e.children,n=t[0].textContent,a=1,i=t.length;i>a;a+=1)n=n+"\n"+t[a].textContent;return n},setTextContent:function(e,t){e.textContent=t},appendTextElement:function(e,t,n,a,i){var o=u.createTextElement(t);o.style.cssText=u.makeCSSText({left:n+"px",top:a+"px","font-size":i+"px"}),e.appendChild(o)},appendImageElement:function(e,t,n,a,i,o){var r=u.createImageElement(t);r.style.cssText=u.makeCSSText({left:n+"px",top:a+"px",width:i+"px",height:o+"px"}),e.appendChild(r)},setOpacity:function(e,t){e.style.opacity=t},setHref:function(e,t){e.setAttribute("href",t)},setDeleteKeyEvent:function(e){u.setEvent(r,"keyup",function(t){8===t.keyCode&&(t.preventDefault(),"function"==typeof e&&e(t))})},getScrollTop:function(){return r.documentElement.scrollTop||r.body.scrollTop},setScrollTop:function(e){r.documentElement.scrollTop=e,r.body.scrollTop=e},getCanvasElement:function(e,t){for(var n=r.getElementsByClassName("canvas-element"),a=n.length-1;a>=0;a-=1){var i=n[a],o=getComputedStyle(i,null),l=parseInt(o.left),s=parseInt(o.top),u=parseInt(o.width),p=parseInt(o.height);if(e>=l&&l+u>=e&&t>=s&&s+p>=t)return i}return null}};e.dom=u;var p={prop:{value:{"in":function(e){this.element._value=e,this.element.updateProperty("isEmpty")}},isEmpty:{out:function(){return""===this.element._value}}}},c={prop:{element:{"in":function(e){var t=this;t.element._element=e;var n=s.debounce(function(){t.element.updateProperty("text")},1e3/60);u.setEvent(e,"keyup",n),u.setEvent(e,"input",n)}},text:{"in":function(e){u.setValue(this.element._element,e),this.element.updateProperty("text")},out:function(){return u.getValue(this.element._element)}}},event:{empty:{"in":function(){u.setValue(this.element._element,""),this.element.updateProperty("text")}}}},d={prop:{element:{"in":function(e){var t=this;t.element._element=e,u.setEvent(e,"click",function(n){u.hasClass(e,"disabled")||t.element.dispatchEvent("click")})}},disabled:{"in":function(e){e?u.addClass(this.element._element,"disabled"):u.removeClass(this.element._element,"disabled")}}},event:{click:{out:i.noop}}},f=i.create({prop:{textarea:{out:function(){return u.get("textarea")}},insertButton:{out:function(){return u.get("insert-button")}},canvas:{out:function(){return u.get("canvas")}},canvasHandle:{out:function(){return{container:u.get("canvas-handle-container"),element:u.get("canvas-handle"),hitarea:u.get("canvas-handle-hitarea"),deleteButton:u.get("canvas-handle-delete-button"),upButton:u.get("canvas-handle-up-button"),downButton:u.get("canvas-handle-down-button"),sizeHandle:u.get("canvas-handle-size-handle")}}},publishTitleText:{out:function(){return u.get("publish-title-text")}},publishButton:{out:function(){return u.get("publish-button")}},publishPage:{out:function(){return{element:u.get("publish-page"),loadingSpinner:u.get("publish-loading-spinner"),link:u.get("publish-link"),closeButton:u.get("publish-close-button")}}}}}),m=i.create(c),h=i.create(p),v=i.create(d),g=i.create({prop:{element:{"in":function(e){var t=this;t.element._element=e,t.element._insert=function(e,t,n,a,i){return""===t?void alert("Load error!"):void(s.isPlainText(t)?u.appendTextElementWithCenterPosition(e,t,n,a,20,i):u.appendImageElementWithCenterPosition(e,t,n,a,i))},u.setDropEvent(e,function(n){t.element._insert(e,n.text,n.x,n.y,function(){t.element.updateProperty("data")})}),u.setDragMoveEvent(e,{handleClass:"canvas-element",start:function(e){var n=e.target;t.element._currentTarget=n;var a=t.element._handleElement;u.setPosition(a.element,u.getPosition(n)),t.element._updateHandleHitarea(),t.element._updateHandleButton(),t.element._updateSizeHandle(),u.removeClass(a.element,"hide"),u.blur(r.activeElement)},drag:function(e){var n=e.target,a=t.element._handleElement;u.setPosition(a.element,u.getPosition(n))},end:function(){t.element.updateProperty("data")}}),u.setEvent(r,u.isTouchEnabled?"touchstart":"mousedown",function(e){var n=e.target,a=t.element._handleElement;if(a){var i=a.element,o=a.container;u.isChild(n,o)||(u.addClass(i,"hide"),t.element._currentTarget=null)}}),u.setDeleteKeyEvent(function(e){t.element._deleteCurrentTarget()})}},input:{"in":function(e){this.element._input=e}},handleElement:{"in":function(e){var t=this;t.element._handleElement=e,t.element._updateHandleHitarea=function(){var e=t.element._currentTarget,n=t.element._handleElement;u.setSize(n.hitarea,u.getSize(e))},t.element._updateHandleButton=function(){var e=t.element._currentTarget,n=t.element._handleElement,a=n.upButton;u.isLastChild(e)?u.addClass(a,"disabled"):u.removeClass(a,"disabled");var i=n.downButton;u.isFirstChild(e)?u.addClass(i,"disabled"):u.removeClass(i,"disabled")},t.element._updateSizeHandle=function(){var e=t.element._currentTarget,n=u.getSize(e),a=t.element._handleElement;u.setPosition(a.sizeHandle,{left:parseInt(n.width)-8+"px",top:parseInt(n.height)-8+"px"})},t.element._deleteCurrentTarget=function(){var e=t.element._currentTarget;if(e){u.remove(e),t.element._currentTarget=null;var n=t.element._handleElement,a=n.element;u.addClass(a,"hide"),t.element.updateProperty("data")}},u.setEvent(e.deleteButton,"click",t.element._deleteCurrentTarget),u.setEvent(e.upButton,"click",function(){if(!u.hasClass(e.upButton,"disabled")){var n=t.element._currentTarget;u.up(n),t.element._updateHandleButton(),t.element.updateProperty("data")}}),u.setEvent(e.downButton,"click",function(){if(!u.hasClass(e.downButton,"disabled")){var n=t.element._currentTarget;u.down(n),t.element._updateHandleButton(),t.element.updateProperty("data")}}),u.setDragEvent(e.sizeHandle,function(){var n,a,i,o,r,l;return{start:function(s,p){n=t.element._currentTarget,i=parseInt(u.getFontSize(n)),o=u.children(n).length,r=u.getSize(n),r.width=parseInt(r.width),r.height=parseInt(r.height),l=r.height/r.width,u.hasClass(n,"canvas-element-text")?a="text":u.hasClass(n,"canvas-element-image")&&(a="image"),u.addClass(e.sizeHandle,"active")},drag:function(e,s){var p=s/e;switch(l>p?e=s/l:s=e*l,a){case"text":var c=i+.85*s/o;12>c&&(c=12),u.setFontSize(n,c.toFixed(1)+"px");break;case"image":var d=r.width+e,f=r.height+s;12>d&&(f=12*l,d=12),12>f&&(d=12/l,f=12),u.setSize(n,{width:d+"px",height:f+"px"})}t.element._updateHandleHitarea(),t.element._updateSizeHandle()},end:function(){t.element.updateProperty("data"),u.removeClass(e.sizeHandle,"active")}}}()),u.setDragEvent(e.hitarea,function(){var e,n;return{start:function(a,i){var o=t.element._currentTarget,r=o.getBoundingClientRect(),l=t.element._handleElement,s=u.getPosition(l.element),p=a-r.left+parseInt(s.left),c=i-r.top+parseInt(s.top)-u.getScrollTop(),d=u.getCanvasElement(p,c);if(null!==d&&d!==o&&p>=0&&640>=p&&c>=0&&480>=c){o=d,t.element._currentTarget=o;var l=t.element._handleElement;u.setPosition(l.element,u.getPosition(o)),t.element._updateHandleHitarea(),t.element._updateHandleButton(),t.element._updateSizeHandle()}e=u.getPosition(o),e.left=parseInt(e.left),e.top=parseInt(e.top),n=u.getSize(o),n.width=parseInt(n.width),n.height=parseInt(n.height)},drag:function(a,i){var o=t.element._currentTarget,r=u.adjustTargetPosition(e.left+a,e.top+i,n.width,n.height);u.setPosition(o,r);var l=t.element._handleElement;u.setPosition(l.element,u.getPosition(o)),t.element._updateHandleHitarea(),t.element._updateHandleButton(),t.element._updateSizeHandle()},end:function(){t.element.updateProperty("data")}}}())}},data:{"in":function(e){for(var t=this.element._element,n=0,a=e.length;a>n;n+=1){var i=e[n],o=i.type;switch(o){case"text":u.appendTextElement(t,i.text,i.left,i.top,i.fontSize);break;case"image":u.appendImageElement(t,i.src,i.left,i.top,i.width,i.height)}}},out:function(){for(var e=[],t=this.element._element,n=u.children(t),a=0,i=n.length;i>a;a+=1){var o=n[a];u.hasClass(o,"canvas-element-text")?e.push({type:"text",text:u.getTextContent(o),left:parseInt(o.style.left),top:parseInt(o.style.top),fontSize:parseFloat(o.style.fontSize)}):u.hasClass(o,"canvas-element-image")&&e.push({type:"image",src:o.getAttribute("src"),left:parseInt(o.style.left),top:parseInt(o.style.top),width:parseInt(o.style.width),height:parseInt(o.style.height)})}return e}}},event:{insert:{"in":function(){var e,t=this;t.element._insert(t.element._element,t.element._input,e,e,function(){t.element.updateProperty("data")})}}}}),x=i.create(c),y=i.create(d),E=i.create({prop:{value:{out:function(){return location.hash.substring(1)}},canvasData:{"in":function(e){this.element._canvasData=e,this.element._updateHash()}},titleText:{"in":function(e){this.element._titleText=e,this.element._updateHash()}},initialCanvasData:{out:function(){var e=this.element._initialHashData();return e?e.data:[]}},initialTitleText:{out:function(){var e=this.element._initialHashData();return e?e.title:""}}}});E._updateHash=s.debounce(function(){var e=this._canvasData,t=this._titleText,n="";if((e.length>0||t)&&(n=o.encodeURI(JSON.stringify({data:e,title:t}))),""===n)var i=u.getScrollTop();location.replace(a+"#"+n),""===n&&u.setScrollTop(i),this.updateProperty("value")},1e3/60),E._initialHashData=function(){var e=location.hash.substring(1),t=null;if(""!==e)try{t=JSON.parse(o.decode(e))}catch(n){alert("Load error!");var i=u.getScrollTop();location.replace(a+"#"),u.setScrollTop(i)}return function(){return t}}();var C=i.create(p),T=i.create({prop:{value:{"in":function(e){r.title=(e||"")+" - OnePage"}}}}),_=i.create({prop:{element:{"in":function(t){function n(){var e=a.element._element,t=e.element;!function n(a){a-=.1,u.setOpacity(t,a),a>=0?setTimeout(function(){n(a)},1e3/60):(u.setOpacity(t,0),u.addClass(t,"hide"),u.addClass(e.loadingSpinner,"hide"),u.addClass(e.link,"hide"))}(1)}var a=this;a.element._element=t,u.setEvent(t.element,"click",function(e){e.target===e.currentTarget&&n()}),u.setEvent(t.closeButton,"click",n),a.element._shortenUrl=function(t,n){!function a(){if("undefined"!=typeof gapi&&gapi.client&&gapi.client.urlshortener){var i=gapi.client.urlshortener.url.insert({resource:{longUrl:t}});i.execute(function(e){null!=e.id&&"function"==typeof n&&n(e.id)})}else e.setTimeout(a,10)}()},e.handleClientLoad=function(){gapi.client.load("urlshortener","v1")},s.loadScript(l)}}},event:{show:{"in":function(){var e=this,t=e.element._element,n=t.element,a=e.element._shortenUrl;u.setOpacity(n,0),u.removeClass(t.loadingSpinner,"hide"),u.removeClass(n,"hide"),function i(t){if(t+=.1,u.setOpacity(n,t),1>=t)setTimeout(function(){i(t)},1e3/60);else{u.setOpacity(n,1);var o=location.href.split("/");o[o.length-1]="viewer.html"+location.hash,a(o.join("/"),function(t){var n=e.element._element,a=n.link;u.setHref(a,t),u.setTextContent(a,t),u.addClass(n.loadingSpinner,"hide"),u.removeClass(a,"hide")})}}(0)}}}});e.onepage={app:{initialize:t},viewer:{initialize:n}}}(this);